{"version":3,"file":"MSEPlayer.umd.js","sources":["../src/MSEPlayer.ts"],"sourcesContent":["// eslint-disable-next-line @typescript-eslint/no-explicit-any\ninterface MSESdkError<T = any> {\n  type: string;\n  error?: T;\n}\n\ninterface Transformer {\n  (buffers: Array<ArrayBuffer>): Array<ArrayBuffer> | Promise<Array<ArrayBuffer>>;\n}\n\ninterface MSESdkOption {\n  // for users, `files` is more meaningful, so I don't use `blobs`\n  files?: Array<Blob>;\n  mimeType?: string;\n  onError?: Function;\n  ignoreError?: boolean;\n  transformer?: Transformer;\n}\n\n/**\n * @example\n * const player = new MSEPlayer()\n * player.appendFiles(files)\n * @see https://developer.mozilla.org/zh-CN/docs/Web/API/Media_Source_Extensions_API\n */\nexport default class MSEPlayer {\n  envSupported: boolean\n  onError: Function\n  mimeType!: string\n  sourceBuffer!: SourceBuffer | null\n  ignoreError!: boolean\n  transformer!: Transformer\n  mediaSource!: MediaSource | null\n  lastAppend$!: Promise<void>\n  constructor (option: MSESdkOption = { }) {\n    const { files = [], mimeType = 'audio/mpeg', onError, ignoreError = true, transformer = identity } = option\n    this.envSupported = MSEPlayer.checkEnvSupported()\n  \n    this.onError = (...args: any[]) => {\n      if (isFunction(onError)) {\n        onError.call(this, ...args)\n      }\n    }\n\n    if (!this.envSupported) {\n      this.onError(genError('MEDIA_SOURCE_NOT_SUPPORTED'))\n      return\n    }\n\n    if (!MediaSource.isTypeSupported(mimeType)) {\n      this.onError(genError('MIME_TYPE_NOT_SUPPORTED'))\n      return\n    }\n\n    this.mimeType = mimeType\n    this.sourceBuffer = null\n    this.ignoreError = ignoreError\n    this.transformer = transformer\n    this.mediaSource = new MediaSource()\n\n    // eslint-disable-next-line @typescript-eslint/no-this-alias\n    const player = this\n    function onSourceOpenWithPromise (): Promise<void> {\n      return new Promise((resolve) => {\n        const mediaSource: MediaSource = player.mediaSource as MediaSource\n        mediaSource.addEventListener('sourceopen', onSourceOpen)\n        function onSourceOpen () {\n          mediaSource.removeEventListener('sourceopen', onSourceOpen)\n          player.sourceBuffer = mediaSource.addSourceBuffer(player.mimeType)\n          resolve()\n        }\n      })\n    }\n\n    this.lastAppend$ = onSourceOpenWithPromise()\n\n    if (files.length > 0) {\n      this.appendFiles(files)\n    }\n  }\n\n  static checkEnvSupported () {\n    return 'MediaSource' in window\n  }\n\n  /**\n   * appendFiles\n   */\n  appendFiles (files: Array<Blob> = [], transformer: Transformer = identity, ignorePrevError = true) {\n    files = toArray(files)\n\n    if (ignorePrevError) {\n      this.lastAppend$.catch(() => { })\n    }\n\n    const combinedTransformer = (buffers: Array<ArrayBuffer>) => {\n      return Promise.resolve(buffers)\n        .then(transformer) // specific transformer\n        .then((buffers) => this.transformer(buffers)) // common transformer\n    }\n\n    const currentAppend$ = this.lastAppend$.then(\n      () => combine(files, this.mediaSource as MediaSource, this.sourceBuffer as SourceBuffer, combinedTransformer)\n    )\n\n    this.lastAppend$ = currentAppend$.catch((err) => {\n      this.onError(genError('APPEND_ERROR', err))\n    })\n\n    return this.ignoreError ? this.lastAppend$ : currentAppend$\n  }\n\n  destroy () {\n    this.mediaSource = null\n    this.sourceBuffer = null\n  }\n}\n\n/**\n * readBuffer - read blobs and get arrayBuffers\n */\nfunction read (blobs: Array<Blob>): Promise<Array<ArrayBuffer>> {\n  return Promise.all(blobs.map(function(blob) {\n    return new Promise<ArrayBuffer>(function(resolve, reject) {\n      // hmmm, no need to unbind, if it's smart enough\n      const reader = new FileReader()\n      reader.addEventListener('load', () => {\n        // the result must be `ArrayBuffer`\n        resolve(reader.result as ArrayBuffer)\n      })\n      reader.readAsArrayBuffer(blob)\n      reader.addEventListener('error', (err) => {\n        reject(genError('READ_FILE_ERROR', err))\n      })\n    })\n  }))\n}\n\n/**\n * buffer - append buffers to specific sourceBuffer\n */\nfunction buffer (mediaSource: MediaSource, sourceBuffer: SourceBuffer, buffers: Array<ArrayBuffer>): Promise<void> {\n  return new Promise((resolve, reject) => {\n    sourceBuffer.addEventListener('updateend', onUpdateEnd)\n    sourceBuffer.addEventListener('error', onAppendError)\n\n    // it's async when `appendBuffer`,\n    // we should use `updateend` event(triggers when `append` or `removed`) to ensure the orders\n    function onUpdateEnd () {\n      if (buffers.length === 0) {\n        mediaSource.endOfStream()\n        // don't forget to remove\n        sourceBuffer.removeEventListener('updateend', onUpdateEnd)\n        sourceBuffer.removeEventListener('error', onAppendError)\n        resolve()\n        return\n      }\n      sourceBuffer.appendBuffer(buffers.shift() as ArrayBuffer)\n    }\n\n    function onAppendError (err: any) {\n      // no need to unbind `updateend` and invoke `endOfStream` here,\n      // because when `error` occurs, `updateend` will go according to the spec.\n      // @see https://w3c.github.io/media-source/#sourcebuffer-append-error\n      reject(genError('APPEND_BUFFER_ERROR', err))\n    }\n\n    // trigger first buffer\n    onUpdateEnd()\n  })\n}\n\n/**\n * combine - combine the `read` process and the `buffer` process\n * to ensure the `read` process is excuted before the `buffer` process.\n * just a combination.\n */\nfunction combine (files: Array<Blob>, mediaSource: MediaSource, sourceBuffer: SourceBuffer, transformer: Transformer) {\n  return read(files).then((buffers) => transformer(buffers)).then((buffers) => buffer(mediaSource, sourceBuffer, buffers))\n}\n\n/**\n * identity\n */\nfunction identity<T> (x: T) {\n  return x\n}\n\n/**\n * isFunction\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction isFunction (x: any): x is Function {\n  return Object.prototype.toString.call(x) === '[object Function]'\n}\n\n/**\n * toArray\n */\nfunction toArray<T> (xs: ArrayLike<T>): Array<T> {\n  return [].slice.call(xs)\n}\n\n/**\n * genError\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction genError<T = any> (type: string, error?: T): MSESdkError<T> {\n  return {\n    type,\n    error\n  }\n}\n"],"names":[],"mappings":"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"}