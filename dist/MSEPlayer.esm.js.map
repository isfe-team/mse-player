{"version":3,"file":"MSEPlayer.esm.js","sources":["../src/helpers/readAsArrayBuffer$.ts","../src/MSEPlayer.ts"],"sourcesContent":["/**\r\n * Simple helper | bqliu\r\n */\r\n\r\nexport default function readAsArrayBuffer$<T extends Blob>(x: T) {\r\n  return new Promise<ArrayBuffer>((resolve, reject) => {\r\n    const fr = new FileReader()\r\n\r\n    // hmmm, no need to unbind, if it's smart enough\r\n    fr.addEventListener('load', () => resolve(fr.result as ArrayBuffer))\r\n    fr.addEventListener('error', (e) => reject(e))\r\n\r\n    fr.readAsArrayBuffer(x)\r\n  });\r\n}\r\n","import readAsArrayBuffer$ from './helpers/readAsArrayBuffer$'\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\ninterface MSESdkError<T = any> {\n  type: string;\n  error?: T;\n}\n\ninterface Transformer {\n  (buffers: Array<ArrayBuffer>): Array<ArrayBuffer> | Promise<Array<ArrayBuffer>>;\n}\n\ninterface MSESdkOption {\n  // for users, `files` is more meaningful, so I don't use `blobs`\n  files?: Array<Blob>;\n  mimeType?: string;\n  onError?: Function;\n  ignoreError?: boolean;\n  transformer?: Transformer;\n}\n\n/**\n * @example\n * const player = new MSEPlayer()\n * player.appendFiles(files)\n * @see https://developer.mozilla.org/zh-CN/docs/Web/API/Media_Source_Extensions_API\n */\nexport default class MSEPlayer {\n  envSupported: boolean\n  onError: Function\n  mimeType!: string\n  sourceBuffer!: SourceBuffer | null\n  ignoreError!: boolean\n  transformer!: Transformer\n  mediaSource!: MediaSource | null\n  lastAppend$!: Promise<void>\n\n  constructor (option: MSESdkOption = { }) {\n    const { files = [], mimeType = 'audio/mpeg', onError, ignoreError = true, transformer = identity } = option\n    this.envSupported = MSEPlayer.checkEnvSupported()\n  \n    this.onError = (...args: any[]) => {\n      if (isFunction(onError)) {\n        onError.call(this, ...args)\n      }\n    }\n\n    if (!this.envSupported) {\n      this.onError(genError('MEDIA_SOURCE_NOT_SUPPORTED'))\n      return\n    }\n\n    if (!MediaSource.isTypeSupported(mimeType)) {\n      this.onError(genError('MIME_TYPE_NOT_SUPPORTED'))\n      return\n    }\n\n    this.mimeType = mimeType\n    this.sourceBuffer = null\n    this.ignoreError = ignoreError\n    this.transformer = transformer\n    this.mediaSource = new MediaSource()\n\n    // eslint-disable-next-line @typescript-eslint/no-this-alias\n    const player = this\n    function onSourceOpenWithPromise (): Promise<void> {\n      return new Promise((resolve) => {\n        const mediaSource: MediaSource = player.mediaSource as MediaSource\n        mediaSource.addEventListener('sourceopen', onSourceOpen)\n        function onSourceOpen () {\n          mediaSource.removeEventListener('sourceopen', onSourceOpen)\n          player.sourceBuffer = mediaSource.addSourceBuffer(player.mimeType)\n          resolve()\n        }\n      })\n    }\n\n    this.lastAppend$ = onSourceOpenWithPromise()\n\n    if (files.length > 0) {\n      this.appendFiles(files)\n    }\n  }\n\n  static checkEnvSupported () {\n    return 'MediaSource' in window\n  }\n\n  /**\n   * appendFiles\n   */\n  appendFiles (files: Array<Blob> = [], transformer: Transformer = identity, ignorePrevError = true) {\n    files = toArray(files)\n\n    if (ignorePrevError) {\n      this.lastAppend$.catch(() => { })\n    }\n\n    const combinedTransformer = (buffers: Array<ArrayBuffer>) => {\n      return Promise.resolve(buffers)\n        .then(transformer) // specific transformer\n        .then((buffers) => this.transformer(buffers)) // common transformer\n    }\n\n    const currentAppend$ = this.lastAppend$.then(\n      () => combine(files, this.mediaSource as MediaSource, this.sourceBuffer as SourceBuffer, combinedTransformer)\n    )\n\n    this.lastAppend$ = currentAppend$.catch((err) => {\n      this.onError(genError('APPEND_ERROR', err))\n    })\n\n    return this.ignoreError ? this.lastAppend$ : currentAppend$\n  }\n\n  destroy () {\n    this.mediaSource = null\n    this.sourceBuffer = null\n  }\n}\n\n/**\n * readBuffer - read blobs and get arrayBuffers\n */\n\nfunction read (blobs: Array<Blob>): Promise<Array<ArrayBuffer>> {\n  return Promise.all(blobs.map(function(blob) {\n    return readAsArrayBuffer$(blob).then(null, (err) => Promise.reject(genError('READ_FILE_ERROR', err)))\n  }))\n}\n\n/**\n * buffer - append buffers to specific sourceBuffer\n */\nfunction buffer (mediaSource: MediaSource, sourceBuffer: SourceBuffer, buffers: Array<ArrayBuffer>): Promise<void> {\n  return new Promise((resolve, reject) => {\n    sourceBuffer.addEventListener('updateend', onUpdateEnd)\n    sourceBuffer.addEventListener('error', onAppendError)\n\n    // it's async when `appendBuffer`,\n    // we should use `updateend` event(triggers when `append` or `removed`) to ensure the orders\n    function onUpdateEnd () {\n      if (buffers.length === 0) {\n        mediaSource.endOfStream()\n        // don't forget to remove\n        sourceBuffer.removeEventListener('updateend', onUpdateEnd)\n        sourceBuffer.removeEventListener('error', onAppendError)\n        resolve()\n        return\n      }\n      sourceBuffer.appendBuffer(buffers.shift() as ArrayBuffer)\n    }\n\n    function onAppendError (err: any) {\n      // no need to unbind `updateend` and invoke `endOfStream` here,\n      // because when `error` occurs, `updateend` will go according to the spec.\n      // @see https://w3c.github.io/media-source/#sourcebuffer-append-error\n      reject(genError('APPEND_BUFFER_ERROR', err))\n    }\n\n    // trigger first buffer\n    onUpdateEnd()\n  })\n}\n\n/**\n * combine - combine the `read` process and the `buffer` process\n * to ensure the `read` process is excuted before the `buffer` process.\n * just a combination.\n */\nfunction combine (files: Array<Blob>, mediaSource: MediaSource, sourceBuffer: SourceBuffer, transformer: Transformer) {\n  return read(files).then((buffers) => transformer(buffers)).then((buffers) => buffer(mediaSource, sourceBuffer, buffers))\n}\n\n/**\n * identity\n */\nfunction identity<T> (x: T) {\n  return x\n}\n\n/**\n * isFunction\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction isFunction (x: any): x is Function {\n  return Object.prototype.toString.call(x) === '[object Function]'\n}\n\n/**\n * toArray\n */\nfunction toArray<T> (xs: ArrayLike<T>): Array<T> {\n  return [].slice.call(xs)\n}\n\n/**\n * genError\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction genError<T = any> (type: string, error?: T): MSESdkError<T> {\n  return {\n    type,\n    error\n  }\n}\n"],"names":[],"mappings":"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"}