{"version":3,"file":"wavToMp3.esm.js","sources":["../../src/helpers/readAsArrayBuffer$.ts","../../src/helpers/wavToMp3.ts"],"sourcesContent":["/**\r\n * Simple helper | bqliu\r\n */\r\n\r\nexport default function readAsArrayBuffer$<T extends Blob>(x: T) {\r\n  return new Promise<ArrayBuffer>((resolve, reject) => {\r\n    const fr = new FileReader()\r\n\r\n    // hmmm, no need to unbind, if it's smart enough\r\n    fr.addEventListener('load', () => resolve(fr.result as ArrayBuffer))\r\n    fr.addEventListener('error', (e) => reject(e))\r\n\r\n    fr.readAsArrayBuffer(x)\r\n  });\r\n}\r\n","/**\n * use [lamejs](https://github.com/zhuker/lamejs#real-example) to encode mp3\n * \n * BE CARE, if use rollup to import lamejs, you will fail, so you need to use\n * [rollup-plugin-external-globals](https://github.com/eight04/rollup-plugin-external-globals)\n * ```js\n * // simple rollup config\n * const config = {\n *   plugins: [nodeResolve(), commonjs(), rollupTypescript(), externalGlobals({ lamejs: 'lamejs' })]\n * }\n * ```\n * @todo\n *  - [ ] pcmToMp3\n */\n\nimport lamejs from 'lamejs'\nimport readAsArrayBuffer$ from './readAsArrayBuffer$'\n\nexport default function wavToMp3 (\n  mp3enc: lamejs.Mp3Encoder,\n  buffers: Array<ArrayBuffer>,\n  {\n    kbps = 128,\n    flush = true,\n    optimize = false // if optimize, we'll slice into pieces, but it will result in unbelivable result\n  } = { }\n): Promise<Array<ArrayBuffer>> {\n  return Promise.all<ArrayBuffer>(buffers.map((buf) => {\n    const wav = lamejs.WavHeader.readHeader(new DataView(buf))\n    const samples = new Int16Array(buf, wav.dataOffset, wav.dataLen / 2)\n    const buffer = [ ]\n\n    if (!mp3enc) {\n      mp3enc = new lamejs.Mp3Encoder(wav.channels, wav.sampleRate, kbps)\n    }\n\n    if (optimize) {\n      let remaining = samples.length\n      const maxSamples = 1152\n      for (let i = 0; remaining >= maxSamples; i += maxSamples) {\n        const mono = samples.subarray(i, i + maxSamples)\n        const mp3buf = mp3enc.encodeBuffer(mono)\n        if (mp3buf.length > 0) {\n          buffer.push(new Int8Array(mp3buf))\n        }\n        remaining -= maxSamples\n      }\n    } else {\n      const mp3buf = mp3enc.encodeBuffer(samples)\n      buffer.push(new Int8Array(mp3buf))\n    }\n\n    if (flush) {\n      const end = mp3enc.flush()\n      if (end.length > 0){\n        buffer.push(new Int8Array(end))\n      }\n    }\n\n    const blob = new Blob(buffer, { type: 'audio/mpeg' })\n    return readAsArrayBuffer$(blob)\n  }))\n}\n"],"names":[],"mappings":";;AAAA;;;AAIA,SAAwB,kBAAkB,CAAiB,CAAI;IAC7D,OAAO,IAAI,OAAO,CAAc,UAAC,OAAO,EAAE,MAAM;QAC9C,IAAM,EAAE,GAAG,IAAI,UAAU,EAAE,CAAA;;QAG3B,EAAE,CAAC,gBAAgB,CAAC,MAAM,EAAE,cAAM,OAAA,OAAO,CAAC,EAAE,CAAC,MAAqB,CAAC,GAAA,CAAC,CAAA;QACpE,EAAE,CAAC,gBAAgB,CAAC,OAAO,EAAE,UAAC,CAAC,IAAK,OAAA,MAAM,CAAC,CAAC,CAAC,GAAA,CAAC,CAAA;QAE9C,EAAE,CAAC,iBAAiB,CAAC,CAAC,CAAC,CAAA;KACxB,CAAC,CAAC;CACJ;;ACdD;;;;;;;;;;;;;;AAeA,SAGwB,QAAQ,CAC9B,MAAyB,EACzB,OAA2B,EAC3B,EAIO;QAJP,4BAIO,EAHL,YAAU,EAAV,+BAAU,EACV,aAAY,EAAZ,iCAAY,EACZ,gBAAgB;MAAhB,qCAAgB;;IAGlB,OAAO,OAAO,CAAC,GAAG,CAAc,OAAO,CAAC,GAAG,CAAC,UAAC,GAAG;QAC9C,IAAM,GAAG,GAAG,MAAM,CAAC,SAAS,CAAC,UAAU,CAAC,IAAI,QAAQ,CAAC,GAAG,CAAC,CAAC,CAAA;QAC1D,IAAM,OAAO,GAAG,IAAI,UAAU,CAAC,GAAG,EAAE,GAAG,CAAC,UAAU,EAAE,GAAG,CAAC,OAAO,GAAG,CAAC,CAAC,CAAA;QACpE,IAAM,MAAM,GAAG,EAAG,CAAA;QAElB,IAAI,CAAC,MAAM,EAAE;YACX,MAAM,GAAG,IAAI,MAAM,CAAC,UAAU,CAAC,GAAG,CAAC,QAAQ,EAAE,GAAG,CAAC,UAAU,EAAE,IAAI,CAAC,CAAA;SACnE;QAED,IAAI,QAAQ,EAAE;YACZ,IAAI,SAAS,GAAG,OAAO,CAAC,MAAM,CAAA;YAC9B,IAAM,UAAU,GAAG,IAAI,CAAA;YACvB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,SAAS,IAAI,UAAU,EAAE,CAAC,IAAI,UAAU,EAAE;gBACxD,IAAM,IAAI,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,GAAG,UAAU,CAAC,CAAA;gBAChD,IAAM,MAAM,GAAG,MAAM,CAAC,YAAY,CAAC,IAAI,CAAC,CAAA;gBACxC,IAAI,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE;oBACrB,MAAM,CAAC,IAAI,CAAC,IAAI,SAAS,CAAC,MAAM,CAAC,CAAC,CAAA;iBACnC;gBACD,SAAS,IAAI,UAAU,CAAA;aACxB;SACF;aAAM;YACL,IAAM,MAAM,GAAG,MAAM,CAAC,YAAY,CAAC,OAAO,CAAC,CAAA;YAC3C,MAAM,CAAC,IAAI,CAAC,IAAI,SAAS,CAAC,MAAM,CAAC,CAAC,CAAA;SACnC;QAED,IAAI,KAAK,EAAE;YACT,IAAM,GAAG,GAAG,MAAM,CAAC,KAAK,EAAE,CAAA;YAC1B,IAAI,GAAG,CAAC,MAAM,GAAG,CAAC,EAAC;gBACjB,MAAM,CAAC,IAAI,CAAC,IAAI,SAAS,CAAC,GAAG,CAAC,CAAC,CAAA;aAChC;SACF;QAED,IAAM,IAAI,GAAG,IAAI,IAAI,CAAC,MAAM,EAAE,EAAE,IAAI,EAAE,YAAY,EAAE,CAAC,CAAA;QACrD,OAAO,kBAAkB,CAAC,IAAI,CAAC,CAAA;KAChC,CAAC,CAAC,CAAA;CACJ;;;;"}