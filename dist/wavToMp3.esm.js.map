{"version":3,"file":"wavToMp3.esm.js","sources":["../src/wavToMp3.ts"],"sourcesContent":["/**\n * use [lamejs](https://github.com/zhuker/lamejs#real-example) to encode mp3\n * @todo\n *  - [ ] to `ts`\n */\n\nimport lamejs from 'lamejs'\n\nexport default function wavToMp3 (buffers: Array<ArrayBuffer>): Promise<Array<ArrayBuffer>> {\n  return Promise.all<ArrayBuffer>(buffers.map((buf) => new Promise((resolve, reject) => {\n    const wav = lamejs.WavHeader.readHeader(new DataView(buf))\n    const samples = new Int16Array(buf, wav.dataOffset, wav.dataLen / 2)\n    const buffer = [ ]\n    const mp3enc = new lamejs.Mp3Encoder(wav.channels, wav.sampleRate, 128)\n\n    let remaining = samples.length\n    const maxSamples = 1152\n    for (let i = 0; remaining >= maxSamples; i += maxSamples) {\n      const mono = samples.subarray(i, i + maxSamples)\n      const mp3buf = mp3enc.encodeBuffer(mono)\n      if (mp3buf.length > 0) {\n        buffer.push(new Int8Array(mp3buf))\n      }\n      remaining -= maxSamples\n    }\n\n    const flush = mp3enc.flush()\n    if (flush.length > 0){\n      buffer.push(new Int8Array(flush))\n    }\n\n    const blob = new Blob(buffer, { type: 'audio/mpeg' })\n    const reader = new FileReader()\n    reader.addEventListener('load', () => {\n      resolve(reader.result as ArrayBuffer)\n    })\n    reader.addEventListener('error', (error) => {\n      reject(error)\n    })\n\n    reader.readAsArrayBuffer(blob)\n  })))\n}\n"],"names":[],"mappings":";;AAAA;;;;;AAMA,SAEwB,QAAQ,CAAE,OAA2B;IAC3D,OAAO,OAAO,CAAC,GAAG,CAAc,OAAO,CAAC,GAAG,CAAC,UAAC,GAAG,IAAK,OAAA,IAAI,OAAO,CAAC,UAAC,OAAO,EAAE,MAAM;QAC/E,IAAM,GAAG,GAAG,MAAM,CAAC,SAAS,CAAC,UAAU,CAAC,IAAI,QAAQ,CAAC,GAAG,CAAC,CAAC,CAAA;QAC1D,IAAM,OAAO,GAAG,IAAI,UAAU,CAAC,GAAG,EAAE,GAAG,CAAC,UAAU,EAAE,GAAG,CAAC,OAAO,GAAG,CAAC,CAAC,CAAA;QACpE,IAAM,MAAM,GAAG,EAAG,CAAA;QAClB,IAAM,MAAM,GAAG,IAAI,MAAM,CAAC,UAAU,CAAC,GAAG,CAAC,QAAQ,EAAE,GAAG,CAAC,UAAU,EAAE,GAAG,CAAC,CAAA;QAEvE,IAAI,SAAS,GAAG,OAAO,CAAC,MAAM,CAAA;QAC9B,IAAM,UAAU,GAAG,IAAI,CAAA;QACvB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,SAAS,IAAI,UAAU,EAAE,CAAC,IAAI,UAAU,EAAE;YACxD,IAAM,IAAI,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,GAAG,UAAU,CAAC,CAAA;YAChD,IAAM,MAAM,GAAG,MAAM,CAAC,YAAY,CAAC,IAAI,CAAC,CAAA;YACxC,IAAI,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE;gBACrB,MAAM,CAAC,IAAI,CAAC,IAAI,SAAS,CAAC,MAAM,CAAC,CAAC,CAAA;aACnC;YACD,SAAS,IAAI,UAAU,CAAA;SACxB;QAED,IAAM,KAAK,GAAG,MAAM,CAAC,KAAK,EAAE,CAAA;QAC5B,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAC;YACnB,MAAM,CAAC,IAAI,CAAC,IAAI,SAAS,CAAC,KAAK,CAAC,CAAC,CAAA;SAClC;QAED,IAAM,IAAI,GAAG,IAAI,IAAI,CAAC,MAAM,EAAE,EAAE,IAAI,EAAE,YAAY,EAAE,CAAC,CAAA;QACrD,IAAM,MAAM,GAAG,IAAI,UAAU,EAAE,CAAA;QAC/B,MAAM,CAAC,gBAAgB,CAAC,MAAM,EAAE;YAC9B,OAAO,CAAC,MAAM,CAAC,MAAqB,CAAC,CAAA;SACtC,CAAC,CAAA;QACF,MAAM,CAAC,gBAAgB,CAAC,OAAO,EAAE,UAAC,KAAK;YACrC,MAAM,CAAC,KAAK,CAAC,CAAA;SACd,CAAC,CAAA;QAEF,MAAM,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAA;KAC/B,CAAC,GAAA,CAAC,CAAC,CAAA;CACL;;;;"}